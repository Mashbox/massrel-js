describe('Context', function() {
  var status = {
    twitter: {"coordinates":null,"truncated":false,"favorited":false,"created_at":"Mon Sep 19 19:35:45 +0000 2011","id_str":"115871720837087233","in_reply_to_user_id_str":null,"entities":{"urls":[{"expanded_url":"http://yfrog.com/nw86936608j","url":"http://t.co/wGCGvo0x","indices":[37,57],"display_url":"yfrog.com/nw86936608j"}],"hashtags":[{"text":"amazing","indices":[11,19]}],"user_mentions":[{"name":"Liz Walker","id_str":"309202074","id":309202074,"indices":[20,36],"screen_name":"texaswalkranger"}]},"entity_id":"115871720837087233","order_id":"115871720837087233","text":"Doub plank #amazing @texaswalkranger http://t.co/wGCGvo0x","contributors":null,"retweet_count":0,"in_reply_to_status_id_str":null,"id":115871720837087233,"geo":null,"retweeted":false,"possibly_sensitive":false,"in_reply_to_user_id":null,"user":{"profile_sidebar_fill_color":"7AC3EE","profile_background_tile":true,"profile_sidebar_border_color":"65B0DA","name":"Rebecca Fahey","location":"","created_at":"Fri Sep 09 20:02:28 +0000 2011","profile_image_url":"http://a3.twimg.com/profile_images/1536247271/omega__normal.png","profile_link_color":"FF0000","is_translator":false,"follow_request_sent":null,"id_str":"370879998","contributors_enabled":false,"favourites_count":5,"default_profile":false,"url":null,"utc_offset":null,"profile_image_url_https":"https://si0.twimg.com/profile_images/1536247271/omega__normal.png","id":370879998,"profile_use_background_image":true,"listed_count":0,"followers_count":37,"protected":false,"profile_text_color":"3D1957","lang":"en","time_zone":null,"verified":false,"geo_enabled":false,"profile_background_color":"642D8B","description":"","profile_background_image_url_https":"https://si0.twimg.com/images/themes/theme10/bg.gif","notifications":null,"default_profile_image":false,"statuses_count":57,"friends_count":106,"profile_background_image_url":"http://a1.twimg.com/images/themes/theme10/bg.gif","show_all_inline_media":false,"following":null,"screen_name":"rebbyfahey"},"place":null,"source":"<a href=\"http://blackberry.com/twitter\" rel=\"nofollow\">Twitter for BlackBerryÂ®</a>","in_reply_to_screen_name":null,"score":"115871720837087233","in_reply_to_status_id":null},
    twitter_with_retweet: {"coordinates":null,"truncated":false,"favorited":false,"created_at":"Mon Sep 19 19:09:44 +0000 2011","retweeted_status":{"coordinates":null,"truncated":false,"favorited":false,"created_at":"Thu Jul 07 17:42:23 +0000 2011","id_str":"89026486857768960","in_reply_to_user_id_str":null,"entities":{"urls":[{"expanded_url":"http://twitpic.com/5mlqn2","url":"http://t.co/38RcMbt","indices":[82,101],"display_url":"twitpic.com/5mlqn2"}],"hashtags":[],"user_mentions":[{"name":"HOT BOY ","id_str":"23357121","id":23357121,"indices":[52,62],"screen_name":"hotboynyc"}]},"text":"lmaooooooooo RT@ _Sweet_Caramel WATTTT LMAOOOOOO RT @hotboynyc RICK ROSS PLANKING http://t.co/38RcMbt","contributors":null,"retweet_count":1,"in_reply_to_status_id_str":null,"id":89026486857768960,"geo":null,"retweeted":false,"possibly_sensitive":false,"in_reply_to_user_id":null,"user":{"profile_sidebar_fill_color":"873287","profile_background_tile":true,"profile_sidebar_border_color":"C0DEED","name":"Rachel B","location":"New york, N.Y","created_at":"Thu Apr 07 02:29:50 +0000 2011","profile_image_url":"http://a0.twimg.com/profile_images/1483342296/normal_DSC_0161__Copy__normal.JPG","profile_link_color":"0084B4","is_translator":false,"follow_request_sent":null,"id_str":"278334372","contributors_enabled":false,"favourites_count":2,"default_profile":false,"url":null,"utc_offset":null,"profile_image_url_https":"https://si0.twimg.com/profile_images/1483342296/normal_DSC_0161__Copy__normal.JPG","id":278334372,"profile_use_background_image":true,"listed_count":1,"followers_count":141,"protected":false,"profile_text_color":"030303","lang":"en","time_zone":null,"verified":false,"geo_enabled":false,"profile_background_color":"2b252b","description":"Its Juice Baby.. You either Love me or leave me alone\r\nhttps://www.facebook.com/profile.php?id=1377360098","profile_background_image_url_https":"https://si0.twimg.com/profile_background_images/304430008/tumblr_lmnbj5AGnM1qf2ango1_500.jpg","notifications":null,"default_profile_image":false,"statuses_count":1761,"friends_count":182,"profile_background_image_url":"http://a3.twimg.com/profile_background_images/304430008/tumblr_lmnbj5AGnM1qf2ango1_500.jpg","show_all_inline_media":false,"following":null,"screen_name":"ThakidJewcee"},"place":null,"source":"web","in_reply_to_screen_name":null,"in_reply_to_status_id":null},"id_str":"115865174673592321","in_reply_to_user_id_str":null,"entities":{"urls":[{"expanded_url":"http://twitpic.com/5mlqn2","url":"http://t.co/38RcMbt","indices":[100,119],"display_url":"twitpic.com/5mlqn2"}],"hashtags":[],"user_mentions":[{"name":"Rachel B","id_str":"278334372","id":278334372,"indices":[3,16],"screen_name":"ThakidJewcee"},{"name":"HOT BOY ","id_str":"23357121","id":23357121,"indices":[70,80],"screen_name":"hotboynyc"}]},"entity_id":"115865174673592321","order_id":"115865174673592321","text":"RT @ThakidJewcee: lmaooooooooo RT@ _Sweet_Caramel WATTTT LMAOOOOOO RT @hotboynyc RICK ROSS PLANKING http://t.co/38RcMbt","contributors":null,"retweet_count":1,"in_reply_to_status_id_str":null,"id":115865174673592321,"geo":null,"retweeted":false,"possibly_sensitive":false,"in_reply_to_user_id":null,"user":{"profile_sidebar_fill_color":"050303","profile_background_tile":true,"profile_sidebar_border_color":"f5030f","name":"Travis Smith","location":"the 434","created_at":"Wed Feb 10 05:12:53 +0000 2010","profile_image_url":"http://a1.twimg.com/profile_images/1526234209/_PoloEverything_normal.jpg","profile_link_color":"0808f0","is_translator":false,"follow_request_sent":null,"id_str":"112936047","contributors_enabled":false,"favourites_count":8,"default_profile":false,"url":null,"utc_offset":-18000,"profile_image_url_https":"https://si0.twimg.com/profile_images/1526234209/_PoloEverything_normal.jpg","id":112936047,"profile_use_background_image":true,"listed_count":12,"followers_count":443,"protected":false,"profile_text_color":"47160d","lang":"en","time_zone":"Quito","verified":false,"geo_enabled":false,"profile_background_color":"000000","description":"Previously known as Redskins081989 #VSU '11 MEN OF NEW WATER 2K11 BOOTZ #teamblackberry bbm:323F87CB #teamiphone #RedskinsNation","profile_background_image_url_https":"https://si0.twimg.com/profile_background_images/323489500/z386690639.jpg","notifications":null,"default_profile_image":false,"statuses_count":13313,"friends_count":389,"profile_background_image_url":"http://a3.twimg.com/profile_background_images/323489500/z386690639.jpg","show_all_inline_media":false,"following":null,"screen_name":"_PoloEverything"},"place":null,"source":"<a href=\"http://www.echofon.com/\" rel=\"nofollow\">Echofon</a>","in_reply_to_screen_name":null,"score":"115865174673592321","in_reply_to_status_id":null},
    facebook: {},
    facebook_no_message: {},
    message: {"kind":"internal_message", "created_at":"Mon Sep 19 03:45:51 UTC 2011", "order_id":"115632665499156480_1316403951_135", "entity_id":"115632665499156480_1316403951_135", "text":"why didnt atlanta run the ball", "id":"115632665499156480_1316403951_135", "network":"massrelevance", "score":"115632665499156480_1316403951_135", "source":"web", "user":{"profile_image_url":"http://api.twitter.com/1/users/profile_image/AskSNF", "id":100, "followers_count":100, "friends_count":100, "screen_name":"AskSNF"}}
  };

  var create_context = massrel.handlebars.prepare_context;

  function sum_matched_sources(sources) {
    var count = 0;
    for(var source in sources) {
      if(sources[source]) {
        count += 1;
      }
    }
    return count;
  }

  it('match twitter', function() {
    var context = create_context(status.twitter);
    expect(context.source.twitter).toBe(true);
    expect(context.known).toBe(true);
    expect(sum_matched_sources(context.source)).toEqual(1);

    expect(context.retweet).toBeFalsy();
    expect(context.retweeted_by_user).toBeUndefined();
  });

  it('match twitter retweet', function() {
    var context = create_context(status.twitter_with_retweet);
    expect(context.source.twitter).toBe(true);
    expect(context.known).toBe(true);
    expect(sum_matched_sources(context.source)).toEqual(1);

    expect(context.retweet).toBe(true);
    expect(context.retweeted_by_user).toBeDefined();
  });

  it('match facebook', function() {
    var context = create_context(status.facebook);
    expect(context.source.facebook).toBe(true);
    expect(context.known).toBe(true);
    expect(sum_matched_sources(context.source)).toEqual(1);
  });

  it('match facebook but not mark if unknown if it has no message', function() {
    var context = create_context(status.facebook_no_message);
    expect(context.source.facebook).toBe(true);
    expect(context.known).toBe(false);
    expect(sum_matched_sources(context.source)).toEqual(1);
  });
  
  it('match internal message', function() {
    var context = create_context(status.message);
    expect(context.source.message).toBe(true);
    expect(context.known).toBe(true);
    expect(sum_matched_sources(context.source)).toEqual(1);
  });

  it('not match other objects', function() {
    // TODO: delete messages

    var context = create_context({});
    expect(context.known).toBe(false);
    expect(sum_matched_sources(context.source)).toEqual(0);

    var context = create_context(null);
    expect(context.known).toBe(false);
    expect(sum_matched_sources(context.source)).toEqual(0);

    var context = create_context(undefined);
    expect(context.known).toBe(false);
    expect(sum_matched_sources(context.source)).toEqual(0);
  });

});
