describe('Context', function() {
  var status = {
    twitter: {"created_at":"Thu Jun 27 18:24:47 +0000 2013","id":350318810957484033,"id_str":"350318810957484033","text":"Steak is what  I need and want right now!!!!!!!!!!!!","source":"web","truncated":false,"in_reply_to_status_id":null,"in_reply_to_status_id_str":null,"in_reply_to_user_id":null,"in_reply_to_user_id_str":null,"in_reply_to_screen_name":null,"user":{"id":18720484,"id_str":"18720484","name":"Karona_Knoxx","screen_name":"Karona_Knoxx","location":"Scarlem","url":null,"description":"Female Rap Artist\r\nI'm The Gurl ur Mom Warned U About   http:\/\/www.myspace.com\/karona","protected":false,"followers_count":378,"friends_count":644,"listed_count":2,"created_at":"Wed Jan 07 13:14:35 +0000 2009","favourites_count":73,"utc_offset":-18000,"time_zone":"Quito","geo_enabled":false,"verified":false,"statuses_count":2714,"lang":"en","contributors_enabled":false,"is_translator":false,"profile_background_color":"9328BD","profile_background_image_url":"http:\/\/a0.twimg.com\/profile_background_images\/640674400\/3ik78qee0r9jjj865jl0.jpeg","profile_background_image_url_https":"https:\/\/si0.twimg.com\/profile_background_images\/640674400\/3ik78qee0r9jjj865jl0.jpeg","profile_background_tile":false,"profile_image_url":"http:\/\/a0.twimg.com\/profile_images\/2703296679\/dd159b6775c108adba45bd98e0194c5f_normal.jpeg","profile_image_url_https":"https:\/\/si0.twimg.com\/profile_images\/2703296679\/dd159b6775c108adba45bd98e0194c5f_normal.jpeg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/18720484\/1357936934","profile_link_color":"2E2C2D","profile_sidebar_border_color":"000000","profile_sidebar_fill_color":"905FC7","profile_text_color":"0E0C12","profile_use_background_image":true,"default_profile":false,"default_profile_image":false,"following":null,"follow_request_sent":null,"notifications":null},"geo":null,"coordinates":null,"place":null,"contributors":null,"retweet_count":0,"favorite_count":0,"entities":{"hashtags":[],"symbols":[],"urls":[],"user_mentions":[]},"favorited":false,"retweeted":false,"filter_level":"medium","lang":"en","network":"twitter","order_id":"350318810957484033","entity_id":"350318810957484033","score":"350318810957484033","queued_at":1372357488305},
    twitter_with_retweet: {"created_at":"Thu Jun 27 18:48:57 +0000 2013","id":350324891028963328,"id_str":"350324891028963328","text":"RT @BL11Courtney: Alex's breakfast ðŸ’™Banana blueberry pancakes!   Mix 2 bananas with 3 eggs and whisk. Fold inâ€¦ http:\/\/t.co\/jHq3PmChNj","source":"<a href=\"http:\/\/twitter.com\/download\/iphone\" rel=\"nofollow\">Twitter for iPhone<\/a>","truncated":false,"in_reply_to_status_id":null,"in_reply_to_status_id_str":null,"in_reply_to_user_id":null,"in_reply_to_user_id_str":null,"in_reply_to_screen_name":null,"user":{"id":544433082,"id_str":"544433082","name":"Kayla","screen_name":"Kailz514","location":"","url":null,"description":"Just a NAIT BBA HRMT student making her way through her 4th and final year!!","protected":false,"followers_count":49,"friends_count":257,"listed_count":0,"created_at":"Tue Apr 03 15:13:20 +0000 2012","favourites_count":15,"utc_offset":-25200,"time_zone":"Mountain Time (US & Canada)","geo_enabled":false,"verified":false,"statuses_count":153,"lang":"en","contributors_enabled":false,"is_translator":false,"profile_background_color":"7514C9","profile_background_image_url":"http:\/\/a0.twimg.com\/profile_background_images\/737127802\/7e4ba09f8116fca2fac9bee816a322b7.jpeg","profile_background_image_url_https":"https:\/\/si0.twimg.com\/profile_background_images\/737127802\/7e4ba09f8116fca2fac9bee816a322b7.jpeg","profile_background_tile":true,"profile_image_url":"http:\/\/a0.twimg.com\/profile_images\/2044677876\/image_normal.jpg","profile_image_url_https":"https:\/\/si0.twimg.com\/profile_images\/2044677876\/image_normal.jpg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/544433082\/1365213839","profile_link_color":"7514C9","profile_sidebar_border_color":"000000","profile_sidebar_fill_color":"000000","profile_text_color":"611CC9","profile_use_background_image":true,"default_profile":false,"default_profile_image":false,"following":null,"follow_request_sent":null,"notifications":null},"geo":null,"coordinates":null,"place":null,"contributors":null,"retweeted_status":{"created_at":"Thu Jun 27 18:31:26 +0000 2013","id":350320483092271104,"id_str":"350320483092271104","text":"Alex's breakfast ðŸ’™Banana blueberry pancakes!   Mix 2 bananas with 3 eggs and whisk. Fold inâ€¦ http:\/\/t.co\/jHq3PmChNj","source":"<a href=\"http:\/\/instagram.com\" rel=\"nofollow\">Instagram<\/a>","truncated":false,"in_reply_to_status_id":null,"in_reply_to_status_id_str":null,"in_reply_to_user_id":null,"in_reply_to_user_id_str":null,"in_reply_to_screen_name":null,"user":{"id":24123921,"id_str":"24123921","name":"Courtney Crozier","screen_name":"BL11Courtney","location":"","url":"http:\/\/www.facebook.com\/BL11Courtney","description":"Sister. Girlfriend. Business Owner. Student. Motivational Speaker. Spinner. Woman of God. Contestant on #BL11 on NBC. I lost over 200lbs! I love life!!! :)","protected":false,"followers_count":43288,"friends_count":376,"listed_count":401,"created_at":"Fri Mar 13 04:02:52 +0000 2009","favourites_count":1181,"utc_offset":-18000,"time_zone":"Quito","geo_enabled":false,"verified":false,"statuses_count":19672,"lang":"en","contributors_enabled":false,"is_translator":false,"profile_background_color":"51EDD8","profile_background_image_url":"http:\/\/a0.twimg.com\/profile_background_images\/536535520\/YOAMAZINGFG.jpg","profile_background_image_url_https":"https:\/\/si0.twimg.com\/profile_background_images\/536535520\/YOAMAZINGFG.jpg","profile_background_tile":true,"profile_image_url":"http:\/\/a0.twimg.com\/profile_images\/3258805937\/34c2d555cf0f81c32d37451a5c305324_normal.jpeg","profile_image_url_https":"https:\/\/si0.twimg.com\/profile_images\/3258805937\/34c2d555cf0f81c32d37451a5c305324_normal.jpeg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/24123921\/1361252778","profile_link_color":"2D77F7","profile_sidebar_border_color":"D1F024","profile_sidebar_fill_color":"000000","profile_text_color":"1AD9D9","profile_use_background_image":true,"default_profile":false,"default_profile_image":false,"following":null,"follow_request_sent":null,"notifications":null},"geo":null,"coordinates":null,"place":null,"contributors":null,"retweet_count":1,"favorite_count":2,"entities":{"hashtags":[],"symbols":[],"urls":[{"url":"http:\/\/t.co\/jHq3PmChNj","expanded_url":"http:\/\/instagram.com\/p\/bEokwAus0G\/","display_url":"instagram.com\/p\/bEokwAus0G\/","indices":[93,115]}],"user_mentions":[]},"favorited":false,"retweeted":false,"possibly_sensitive":false,"lang":"de"},"retweet_count":0,"favorite_count":0,"entities":{"hashtags":[],"symbols":[],"urls":[{"url":"http:\/\/t.co\/jHq3PmChNj","expanded_url":"http:\/\/instagram.com\/p\/bEokwAus0G\/","display_url":"instagram.com\/p\/bEokwAus0G\/","indices":[111,133]}],"user_mentions":[{"screen_name":"BL11Courtney","name":"Courtney Crozier","id":24123921,"id_str":"24123921","indices":[3,16]}]},"favorited":false,"retweeted":false,"possibly_sensitive":false,"filter_level":"medium","lang":"de","network":"twitter","order_id":"350324891028963328","entity_id":"350324891028963328","score":"350324891028963328","queued_at":1372358937874},
    facebook: {"facebook_id":"100000742900446_144972738932404","name":"Yolanda Adams - Open My Heart","kind":"video","from":{"name":"Alvin Davis","id":"100000742900446"},"entity_id":"100000742900446_144972738932404","order_id":"100000742900446_144972738932404","application":null,"icon":"http://static.ak.fbcdn.net/rsrc.php/v1/yj/r/v2OnaTyTQZE.gif","id":"100000742900446_144972738932404","network":"facebook","created_time":"2011-09-28T17:37:52+0000","type":"video","caption":"www.youtube.com","updated_time":"2011-09-28T17:37:52+0000","description":"Great Song By Yolanda Adams.","link":"http://www.youtube.com/watch?v=2aYzc0Z0Z8Q&feature=share","source":"http://www.youtube.com/v/2aYzc0Z0Z8Q?version=3&autohide=1&autoplay=1","message":"Everyone,its good that we open our minds to Gods unchanging hand and blessings of guidance but what God wants is our hearts and souls to be complete within Him,not humans but God for everything human is meaning less without God in your life and leading your direction to his unchanging hand,lets Love God as He Loves us,open your heart to God,who should always be first in your life anyway-feel me-Alvin","score":"100000742900446_144972738932404","picture":"http://external.ak.fbcdn.net/safe_image.php?d=AQA7jqbDTqC21wer&w=130&h=130&url=http%3A%2F%2Fi3.ytimg.com%2Fvi%2F2aYzc0Z0Z8Q%2Fdefault.jpg"},
    // facebook_no_message: {"facebook_id":"748470021_273969382628352","name":"Funny Novak Djokovic Impressions at the UsOpen 07 Exclusive!","kind":"video","story":"Abhijit Samanta shared a link.","from":{"name":"Abhijit Samanta","id":"748470021"},"entity_id":"748470021_273969382628352","order_id":"748470021_273969382628352","application":{"name":"Links","id":"2309869772"},"icon":"http://static.ak.fbcdn.net/rsrc.php/v1/yj/r/v2OnaTyTQZE.gif","story_tags":{"0":[{"name":"Abhijit Samanta","id":748470021,"length":15,"offset":0}]},"id":"748470021_273969382628352","network":"facebook","created_time":"2011-09-24T00:50:10+0000","type":"video","caption":"www.youtube.com","updated_time":"2011-09-24T00:50:10+0000","description":"http://www.tennisplaza.com - Top Tennis Store Im a big fan of Novak Djokovic. Here he is having fun with some Argentinian tennis players before his Stepanek ...","link":"http://www.youtube.com/watch?v=xYA_7RUSarU&feature=share","source":"http://www.youtube.com/v/xYA_7RUSarU?version=3&autohide=1","score":"748470021_273969382628352","picture":"http://external.ak.fbcdn.net/safe_image.php?d=AQCE5vp63JsVaHwc&w=130&h=130&url=http%3A%2F%2Fi1.ytimg.com%2Fvi%2FxYA_7RUSarU%2Fdefault.jpg"},
    message: {"kind":"internal_message", "created_at":"Mon Sep 19 03:45:51 UTC 2011", "order_id":"115632665499156480_1316403951_135", "entity_id":"115632665499156480_1316403951_135", "text":"why didnt atlanta run the ball", "id":"115632665499156480_1316403951_135", "network":"massrelevance", "score":"115632665499156480_1316403951_135", "source":"web", "user":{"profile_image_url":"http://api.twitter.com/1/users/profile_image/AskSNF", "id":100, "followers_count":100, "friends_count":100, "screen_name":"AskSNF"}}
  };

  var create_context = massrel.Context.create;

  function sum_matched_sources(sources) {
    var count = 0;
    for(var source in sources) {
      if(sources[source]) {
        count += 1;
      }
    }
    return count;
  }

  it('match twitter', function() {
    var context = create_context(status.twitter);
    expect(context.source.twitter).toBe(true);
    expect(context.known).toBe(true);
    expect(sum_matched_sources(context.source)).toEqual(1);

    expect(context.retweet).toBeFalsy();
    expect(context.retweeted_by_user).toBeUndefined();
  });

  it('match twitter retweet', function() {
    var context = create_context(status.twitter_with_retweet);
    expect(context.source.twitter).toBe(true);
    expect(context.known).toBe(true);
    expect(sum_matched_sources(context.source)).toEqual(1);

    expect(context.retweet).toBe(true);
    expect(context.retweeted_by_user).toBeDefined();

    // naive way to make sure every thing was shifted around correctly
    expect(status.twitter_with_retweet.text).toEqual('RT @'+context.status.user.screen_name+': '+context.status.text);
  });

  it('match facebook', function() {
    var context = create_context(status.facebook);
    expect(context.source.facebook).toBe(true);
    expect(context.known).toBe(true);
    expect(sum_matched_sources(context.source)).toEqual(1);
  });

  // TODO: is this test necessary anymore?
  // it('match facebook but not mark if unknown if it has no message', function() {
  //   var context = create_context(status.facebook_no_message);
  //   expect(context.source.facebook).toBe(true);
  //   expect(context.known).toBe(false);
  //   expect(sum_matched_sources(context.source)).toEqual(1);
  // });

  it('match internal message', function() {
    var context = create_context(status.message);
    expect(context.source.message).toBe(true);
    expect(context.known).toBe(true);
    expect(sum_matched_sources(context.source)).toEqual(1);
  });

  it('not match other objects', function() {
    // TODO: delete messages

    var context = create_context({});
    expect(context.known).toBe(false);
    expect(sum_matched_sources(context.source)).toEqual(0);

    context = create_context({ network: 'foobarbaz' });
    expect(context.known).toBe(false);
    expect(sum_matched_sources(context.source)).toEqual(0);

    context = create_context(null);
    expect(context.known).toBe(false);
    expect(sum_matched_sources(context.source)).toEqual(0);

    context = create_context(undefined);
    expect(context.known).toBe(false);
    expect(sum_matched_sources(context.source)).toEqual(0);
  });

  it('default to intents enabled', function() {
    var raw_context = new massrel.Context();
    expect(raw_context.intents).toBe(true);

    var context = create_context(status.twitter);
    expect(context.intents).toBe(true);

    context = create_context(status.twitter, {
      intents: true
    });
    expect(context.intents).toBe(true);

    context = create_context(status.twitter, {
      intents: false
    });
    expect(context.intents).toBe(false);


  });

});
